<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question {{ question_num }} - Mind Mashup</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üß† Mind Mashup</h1>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (question_num / total_questions) * 100 }}%"></div>
            </div>
            <p class="question-progress">Question {{ question_num }} of {{ total_questions }}</p>
        </header>

        <div class="question-card">
            <div class="question-header">
                <h2 class="category">{{ question.category }}</h2>
                <div class="timer-container">
                    <div id="timer" class="timer">
                        <span id="timeRemaining">{{ question.time_limit }}</span>s
                    </div>
                    <button id="distractionBtn" class="distraction-btn" title="Play distraction sound">üîä</button>
                </div>
            </div>

            {% if question.sequence_view_time %}
            <div id="sequenceView" class="sequence-view">
                <h3>Memorize this sequence ({{ question.sequence_view_time }} seconds):</h3>
                <div class="sequence">7, 14, 21, 28, 35, 42, 49, 56</div>
                <div class="sequence-timer">
                    <span id="sequenceTimeRemaining">{{ question.sequence_view_time }}</span>s
                </div>
            </div>
            {% endif %}

            <div id="questionContent" class="question-content" {% if question.sequence_view_time %}style="display: none;"{% endif %}>
                <p class="question-text">{{ question.question | safe }}</p>
                
                <div class="answer-section">
                    <input type="text" id="answerInput" placeholder="Enter your answer..." maxlength="200">
                    <button id="submitBtn" class="btn-primary">Submit Answer</button>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <a href="/scoreboard" class="btn-secondary">View Scoreboard</a>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h3 id="resultTitle">Result</h3>
            <p id="resultMessage"></p>
            <div id="explanation" class="explanation"></div>
            <div id="scoreInfo" class="score-info"></div>
            <button id="nextBtn" class="btn-primary">Continue</button>
        </div>
    </div>

    <!-- Time Up Modal -->
    <div id="timeUpModal" class="modal">
        <div class="modal-content">
            <h3>‚è∞ Time's Up!</h3>
            <p>You ran out of time for this question.</p>
            <button id="timeUpNextBtn" class="btn-primary">Continue</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        const questionData = {{ question | tojsonfilter | safe }};
        const questionId = {{ question.id }};
        let timeRemaining = {{ question.time_limit }};
        let timerInterval;
        let sequenceTimerInterval;

        document.addEventListener('DOMContentLoaded', function() {
            // Handle sequence viewing for sequence recall questions
            {% if question.sequence_view_time %}
            startSequenceTimer();
            {% else %}
            startMainTimer();
            {% endif %}

            // Set up event listeners
            document.getElementById('submitBtn').addEventListener('click', submitAnswer);
            document.getElementById('answerInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAnswer();
                }
            });
            document.getElementById('distractionBtn').addEventListener('click', playDistraction);
            document.getElementById('nextBtn').addEventListener('click', goToNext);
            document.getElementById('timeUpNextBtn').addEventListener('click', goToNext);

            // Focus on answer input
            {% if not question.sequence_view_time %}
            document.getElementById('answerInput').focus();
            {% endif %}
        });

        function startSequenceTimer() {
            let sequenceTime = {{ question.sequence_view_time or 0 }};
            document.getElementById('sequenceTimeRemaining').textContent = sequenceTime;

            sequenceTimerInterval = setInterval(function() {
                sequenceTime--;
                document.getElementById('sequenceTimeRemaining').textContent = sequenceTime;

                if (sequenceTime <= 0) {
                    clearInterval(sequenceTimerInterval);
                    document.getElementById('sequenceView').style.display = 'none';
                    document.getElementById('questionContent').style.display = 'block';
                    document.getElementById('answerInput').focus();
                    startMainTimer();
                }
            }, 1000);
        }

        function startMainTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(function() {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = minutes > 0 ? `${minutes}:${seconds.toString().padStart(2, '0')}` : `${seconds}`;
            document.getElementById('timeRemaining').textContent = display;
            
            // Add warning class when time is low
            const timer = document.getElementById('timer');
            if (timeRemaining <= 30) {
                timer.classList.add('timer-warning');
            }
            if (timeRemaining <= 10) {
                timer.classList.add('timer-danger');
            }
        }

        function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('Please enter an answer');
                return;
            }

            // Disable submit button and input
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            clearInterval(timerInterval);

            fetch('/submit_answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    answer: answer,
                    question_id: questionId
                })
            })
            .then(response => response.json())
            .then(data => {
                showResult(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to submit answer. Please try again.');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('answerInput').disabled = false;
            });
        }

        function showResult(data) {
            const modal = document.getElementById('resultModal');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');
            const explanation = document.getElementById('explanation');
            const scoreInfo = document.getElementById('scoreInfo');

            if (data.correct) {
                title.textContent = 'üéâ Correct!';
                title.className = 'result-correct';
                message.textContent = 'Well done! You got it right.';
            } else {
                title.textContent = '‚ùå Incorrect';
                title.className = 'result-incorrect';
                message.textContent = `The correct answer was: ${data.correct_answer}`;
            }

            if (data.explanation) {
                explanation.innerHTML = `<strong>Explanation:</strong> ${data.explanation}`;
                explanation.style.display = 'block';
            } else {
                explanation.style.display = 'none';
            }

            scoreInfo.textContent = `Points earned: ${data.points}`;

            modal.style.display = 'flex';
        }

        function timeUp() {
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;
            document.getElementById('timeUpModal').style.display = 'flex';
        }

        function goToNext() {
            window.location.href = '/question';
        }

        function playDistraction() {
            // Play a beep sound or distraction
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.5);
        }
    </script>
</body>
</html>